(in-package :clfswm)

(defun update-layout-managed-children-keep-position (child parent)
  (let ((managed-children (frame-data-slot parent :layout-managed-children))
	(managed-in-parent (get-managed-child parent)))
    (dolist (ch managed-in-parent)
      (unless (child-member ch managed-children)
	(setf managed-children (append managed-children (list ch)))))
    (setf managed-children (remove-if-not (lambda (x)
					    (child-member x managed-in-parent))
					  managed-children))
    (setf (frame-data-slot parent :layout-managed-children) managed-children)
    managed-children))

;;; Redefine Space layout
(defun tile-space-layout (child parent)
  "Tile Space: tile child in its frame leaving spaces between them"
  (with-slots (rx ry rw rh) parent
    (let* ((managed-children (update-layout-managed-children child parent))
	   (pos (child-position child managed-children))
	   (len (length managed-children))
	   (cols (ceiling (sqrt len)))
           (rows (ceiling (/ len cols)))
           (col (mod pos cols))
           (row (floor pos cols))
	   (space-percent (or (frame-data-slot parent :tile-space-size) 0.05))
           (col-space-total (* rw space-percent))
           (row-space-total (* rh space-percent))
           (col-space (floor col-space-total (1+ cols)))
           (row-space (floor row-space-total (1+ rows)))
           (child-width (floor (- rw col-space-total) cols))
           (child-height (floor (- rh row-space-total) rows))
           )
      (values (round (print (adj-border-xy (+ rx col-space (* (+ col-space child-width) col)) child)))
              (round (print (adj-border-xy (+ ry row-space (* (+ row-space child-height) row)) child)))
	      (round (print (adj-border-wh child-width child)))
	      (round (print (adj-border-wh child-height child)))))))


(defmacro frame-tree (params &rest children)
  `(let ((frame (create-frame ,@params)))
    (dolist (child (list ,@children))
      (add-frame child frame))
    frame))

(defun run-in-frame (frame cmd &optional (delay 0))
  (let ((old-current-child *current-child*))
    (setf *current-child* frame)
    (if (listp cmd)
        (dolist (c cmd)
          (do-shell c))
        (do-shell cmd))
;    (with-timer (delay)
;      (setf *current-child* old-current-child))
  )
  frame)

(defun my-init-hook ()
  (dbg 'my-init-hook)
  (setf (frame-layout *root-frame*) #'tile-space-layout
        (frame-data-slot *root-frame* :tile-space-size) 0.05
        (frame-data-slot *root-frame* :tile-layout-keep-position) :yes)
  (let* (
         (utility-frame (add-frame (create-frame
                                    :name "Utility"
                                    :layout #'tile-space-layout
                                    :data (list '(:tile-layout-keep-position :yes)
                                                '(:tile-space-size 0.05)))
                                   *root-frame*))
         (work-frame (add-frame (create-frame
                                 :name "Work"
                                 :layout #'tile-horizontal-layout
                                 :data (list '(:tile-layout-keep-position :yes)))
                                *root-frame*))
         (distractors-frame (add-frame (create-frame
                                        :name "Distractors"
                                        :layout #'tile-horizontal-layout
                                        :data (list '(:tile-layout-keep-position :yes)))
                                       *root-frame*))
         (communications-frame (add-frame 
                                (create-frame :name "Communications"
                                              :layout #'maximize-layout)
                                *root-frame*))
         (communications-inner-frame (add-frame
                                      (create-frame
                                       :name "Communications:inner"
                                       :layout #'tile-horizontal-layout
                                       :data (list '(:tile-layout-keep-position :yes)))
                                      communications-frame))
         (skype-frame (add-frame (create-frame :name "Skype"
                                               :layout #'main-window-left-layout
                                               :data (list '(:tile-size 0.2)))
                                 communications-inner-frame))
         (im-frame (add-frame (create-frame :name "IM"
                                            :layout #'main-window-left-layout
                                            :data (list '(:tile-size 0.2)))
                              communications-inner-frame))
         (mail-frame (add-frame (create-frame :name "Mail"
                                              :layout #'maximize-layout)
                                communications-inner-frame))
         )
    (setf *current-child* distractors-frame)
    (run-in-frame skype-frame "skype" 20)
    ))

(setf *init-hook* '(my-init-hook))

;; (do-shell "exec apwal")

;; (my-frame (:name "Communications" :layout #'tile-left-layout :data (list '(:tile-size 0.6)))

